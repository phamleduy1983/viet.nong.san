@using ArduinoService.Resource
@{
    ViewBag.Title = "Control Systems ioT";
}
<link href="~/Content/TrackingData.css" rel="stylesheet" />

<div id="contain" class="tracking-data">
    <div id="status-total" class="col-sm-12">
        @*<img class="img-status" src="~/Content/Images/IconStatus/Emoticons_smile.png" />*@
        <img class="img-status" src="~/Content/Imggif/b0220.gif" />
        <div id="message-status">
            <span></span>
        </div>
    </div>

    <div class="col-sm-12 margin-bottom-10">
        <div class="box-shadow">
            <div id="temperature" class="col-xs-4 col-md-4 current-tracking">
                <span>0℃</span>
            </div>
            <div id="humidity" class="col-xs-4 col-md-4 current-tracking">
                <span>0%</span>
            </div>
            <div id="moisture" class="col-xs-4 col-md-4 current-tracking">
                <span>0%</span>
            </div>
        </div>
    </div>

    <div class="col-sm-12">
        <span class="title">@Languages._0021</span>
    </div>

    <div class="col-sm-12">
        <div class="table-responsive">
            <table class="table table-simple" id="table-history">
                <thead>
                    <tr>
                        <th class="number">@Languages._0015</th>
                        <th class="truncate">@Languages._0013</th>
                        <th class="truncate">@Languages._0014</th>
                        <th class="truncate">@Languages._0019</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</div>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {

            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.TrackingData;
            // Create a function that the hub can call back to display messages.
            chat.client.SendClient = function (data) {
                var object = JSON.parse(data);

                // Update list data by ajax
                GetlistTrackingHistory();

                // Update view
                $('#temperature span').text(object[0].TEMPERATURE + "℃");
                $('#humidity span').text(object[0].HUMIDITY + "%");
                $('#moisture span').text(object[0].MOISTURE + "%");
            };
        });

        $.connection.hub.start().done(function () {
            // Get list data
            GetlistTrackingHistory();
            ShowMessageStatus();
        });

        function GetlistTrackingHistory() {
            $.ajax({
                method: "POST",
                async: true,
                url: "/Home/GetListTrackingHistory",
                dataType: "JSON"
            }).success(function (msg) {
                if (msg != "") {
                    // Update list history
                    var html = "";
                    $.each(msg, function (index, value) {
                        html += "<tr><td>" + value.Time + "</td><td>" + value.TEMPERATURE + "℃</td><td>" + value.HUMIDITY + "%</td><td>" + value.MOISTURE + "%</td></tr>";
                    });
                    $("#table-history tbody").hide('slow').html(html).show('slow');

                    // set current temperature
                    $('#temperature span').slideUp(100).text(msg[0].TEMPERATURE + "℃").slideDown(100);
                    $('#humidity span').slideUp(100).text(msg[0].HUMIDITY + "%").slideDown(100);
                    $('#moisture span').slideUp(100).text(msg[0].MOISTURE + "%").slideDown(100);

                    // show message status
                    // set message
                    var message = "";
                    if (parseInt(msg[0].TEMPERATURE) > 30)
                        message = "Nóng quá !!! Tôi cần thêm một ít nước :( ";
                    else if (parseInt(msg[0].TEMPERATURE) < 30)
                        message = "Nước có vẻ hơi nhiều rồi bạn ơi !!! ";
                    else
                        message = "Hiện tại tôi rất thoải mái :) ... Cám ơn bạn dã chăm sóc cho tui =)) ";

                    $('#message-status span').slideUp(100).text(message).slideDown(100);
                    ShowMessageStatus();
                }
            });
        }


        function ShowMessageStatus() {
            // show message status
            var posLeft = $('.img-status').position().left + 55;
            var posTop = $('.img-status').position().top;
            $('#message-status').css({ left: posLeft, top: posTop });
        }

        $(window).resize(function () {
            ShowMessageStatus();
        });

    </script>
}
